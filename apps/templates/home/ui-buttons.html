{% extends "layouts/base.html" %}

{% block title %}HR – Employee Overview{% endblock %}

{% block stylesheets %}
<style>
  .kpi-card { min-height: 120px; }
  .kpi-sub { font-size: 0.8rem; color: #6c757d; }
  .avatar { width: 28px; height: 28px; border-radius: 999px; object-fit: cover; }
  .table-sticky thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
  .risk-low { background: #e8f5e9; }
  .risk-med { background: #fff8e1; }
  .risk-high { background: #ffebee; }
</style>
{% endblock stylesheets %}

{% block content %}
<main class="content">
  <div class="container-fluid p-0">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 mb-0"><i class="align-middle mr-2" data-feather="users"></i> Employee Dashboard – HR Overview</h1>
      <div class="text-muted" id="todayNow">Today is —</div>
    </div>

    <!-- KPIs -->
    <div class="row">
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center">
            <div class="mr-3"><i data-feather="headphones"></i></div>
            <div>
              <div class="text-muted small">Headcount</div>
              <div class="h3 mb-0" id="kpiHeadcount">--</div>
              <div class="kpi-sub" id="kpiActive">Active employees</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center">
            <div class="mr-3"><i data-feather="trending-down"></i></div>
            <div>
              <div class="text-muted small">Turnover (L12M)</div>
              <div class="h3 mb-0" id="kpiTurnover">--</div>
              <div class="kpi-sub" id="kpiTurnoverCount">— separations</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center">
            <div class="mr-3"><i data-feather="clock"></i></div>
            <div>
              <div class="text-muted small">Average Tenure</div>
              <div class="h3 mb-0" id="kpiTenure">--</div>
              <div class="kpi-sub">Across active employees</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3 mb-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body d-flex align-items-center">
            <div class="mr-3"><i data-feather="star"></i></div>
            <div>
              <div class="text-muted small">Perf Reviews / Employee</div>
              <div class="h3 mb-0" id="kpiReviews">--</div>
              <div class="kpi-sub" id="kpiLastCycle">Last cycle —</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8 mb-3">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h3 class="card-title mb-0">Headcount & Turnover Trend</h3>
              <div class="card-subtitle text-muted">Last 12 months</div>
            </div>
          </div>
          <div class="card-body">
            <canvas id="trendChart" height="120"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-4 mb-3">
        <div class="card shadow-sm">
          <div class="card-header">
            <h3 class="card-title mb-0">Tenure Distribution</h3>
            <div class="card-subtitle text-muted">Active employees</div>
          </div>
          <div class="card-body">
            <canvas id="tenureChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-6 mb-3">
        <div class="card shadow-sm">
          <div class="card-header">
            <h3 class="card-title mb-0">Performance Review Cadence</h3>
            <div class="card-subtitle text-muted">Reviews per employee, last 12 months</div>
          </div>
          <div class="card-body">
            <canvas id="reviewsChart" height="140"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-3">
        <div class="card shadow-sm table-sticky">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Employee Overview</h3>
            <div class="small text-muted">Sample data</div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 360px;">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Employee</th>
                    <th>Team</th>
                    <th>Tenure</th>
                    <th>Reviews (12m)</th>
                    <th>Avg Rating</th>
                    <th>Last Review</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="empTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>
{% endblock content %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  feather.replace();

  // ---- Static placeholder data ----
  const sample = {
    headcountMonthly: {
      // months in order, last 12
      labels: ['Sep','Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug'],
      headcount: [92,95,97,99,100,102,104,106,108,110,111,113],
      separations: [2,1,0,1,0,2,1,1,0,2,1,1]
    },
    tenureBuckets: {
      labels: ['< 6m','6–12m','1–2y','2–3y','3–5y','5y+'],
      counts: [14, 18, 30, 20, 22, 9]
    },
    reviewsPerEmployee: {
      buckets: ['0','1','2','3','4+'],
      counts: [5, 38, 42, 18, 10]
    },
    employees: [
      { name: 'Alex Santos',  team: 'Web',     avatar: 'https://i.pravatar.cc/48?img=1', tenureMonths: 28, reviews12m: 3, avgRating: 4.3, lastReview: '2025-07-15', status: 'Active' },
      { name: 'Bianca Cruz',  team: 'Android', avatar: 'https://i.pravatar.cc/48?img=2', tenureMonths: 8,  reviews12m: 2, avgRating: 3.9, lastReview: '2025-06-30', status: 'Active' },
      { name: 'Carlo Dizon',  team: 'Data',    avatar: 'https://i.pravatar.cc/48?img=3', tenureMonths: 40, reviews12m: 4, avgRating: 4.6, lastReview: '2025-05-20', status: 'Active' },
      { name: 'Diane Uy',     team: 'iOS',     avatar: 'https://i.pravatar.cc/48?img=4', tenureMonths: 14, reviews12m: 2, avgRating: 4.2, lastReview: '2025-08-05', status: 'Active' },
      { name: 'Eli Ramos',    team: 'Web',     avatar: 'https://i.pravatar.cc/48?img=5', tenureMonths: 6,  reviews12m: 1, avgRating: 3.6, lastReview: '2025-04-18', status: 'Active' },
      { name: 'Faye Lim',     team: 'Android', avatar: 'https://i.pravatar.cc/48?img=6', tenureMonths: 56, reviews12m: 4, avgRating: 4.7, lastReview: '2025-08-10', status: 'Active' }
    ],
    lastCycleLabel: 'H1 2025',
    timezone: 'Asia/Manila'
  };

  // ---- Helpers ----
  function monthsToYrsMo(m){
    const y = Math.floor(m/12), mo = m%12; return y?`${y}y ${mo}m`:`${mo}m`;
  }
  function calcTurnoverPct(headcountSeries, sepSeries){
    // Simple annualized turnover: total separations last 12m / avg headcount
    const totalSep = sepSeries.reduce((a,b)=>a+b,0);
    const avgHC = headcountSeries.reduce((a,b)=>a+b,0)/headcountSeries.length;
    return { pct: (totalSep/avgHC*100), count: totalSep };
  }
  function formatToday(tz){
    try{
      const now = new Date();
      const day = new Intl.DateTimeFormat('en-US',{ weekday:'long', timeZone: tz }).format(now);
      const date = new Intl.DateTimeFormat('en-US',{ year:'numeric', month:'long', day:'2-digit', timeZone: tz }).format(now);
      const time = new Intl.DateTimeFormat('en-US',{ hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true, timeZone: tz }).format(now);
      return `Today is ${day}, ${date} — ${time} (${tz})`;
    }catch(e){
      return 'Today is —';
    }
  }

  // ---- Render KPIs ----
  const hc = sample.headcountMonthly.headcount;
  const sep = sample.headcountMonthly.separations;
  const t = calcTurnoverPct(hc, sep);
  const avgTenureMonths = Math.round(sample.employees.reduce((s,e)=>s+e.tenureMonths,0)/sample.employees.length);
  const avgReviews = sample.employees.reduce((s,e)=>s+e.reviews12m,0)/sample.employees.length;

  document.getElementById('todayNow').textContent = formatToday(sample.timezone);
  document.getElementById('kpiHeadcount').textContent = hc[hc.length-1];
  document.getElementById('kpiActive').textContent = `${hc[hc.length-1]} active employees`;
  document.getElementById('kpiTurnover').textContent = (t.pct).toFixed(1) + '%';
  document.getElementById('kpiTurnoverCount').textContent = `${t.count} separations in last 12 months`;
  document.getElementById('kpiTenure').textContent = monthsToYrsMo(avgTenureMonths);
  document.getElementById('kpiReviews').textContent = avgReviews.toFixed(1);
  document.getElementById('kpiLastCycle').textContent = `Last cycle ${sample.lastCycleLabel}`;

  // ---- Charts ----
  const labels = sample.headcountMonthly.labels;
  const trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Headcount', data: hc, borderWidth: 2, tension: .35, yAxisID: 'y1' },
        { label: 'Separations', data: sep, type: 'bar', borderWidth: 1, yAxisID: 'y2' }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        y1: { type: 'linear', position: 'left', suggestedMin: 0 },
        y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, suggestedMin: 0 }
      }
    }
  });

  const tenureChart = new Chart(document.getElementById('tenureChart'), {
    type: 'doughnut',
    data: { labels: sample.tenureBuckets.labels, datasets: [{ data: sample.tenureBuckets.counts }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });

  const reviewsChart = new Chart(document.getElementById('reviewsChart'), {
    type: 'bar',
    data: { labels: sample.reviewsPerEmployee.buckets, datasets: [{ label: 'Employees', data: sample.reviewsPerEmployee.counts }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // ---- Table ----
  const tbody = document.getElementById('empTable');
  sample.employees.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="align-middle"><img class="avatar mr-2" src="${e.avatar}" alt="${e.name}"> ${e.name}</td>
      <td class="align-middle">${e.team}</td>
      <td class="align-middle">${monthsToYrsMo(e.tenureMonths)}</td>
      <td class="align-middle">${e.reviews12m}</td>
      <td class="align-middle">${e.avgRating.toFixed(1)}</td>
      <td class="align-middle">${new Date(e.lastReview).toLocaleDateString()}</td>
      <td class="align-middle">${e.status}</td>
    `;
    tbody.appendChild(tr);
  });
})();
</script>
{% endblock javascripts %}